name: Fetch Menu from Airtable

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch from Airtable
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          AIRTABLE_BASE: ${{ secrets.AIRTABLE_BASE }}
        run: |
          echo "Fetching from Airtable..."
          
          mkdir -p data
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.json \
            -H "Authorization: Bearer ${AIRTABLE_TOKEN}" \
            "https://api.airtable.com/v0/${AIRTABLE_BASE}/menu%20storage?pageSize=100")
          
          echo "HTTP Status: ${HTTP_CODE}"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error response:"
            cat response.json
            exit 1
          fi
          
          echo "Extracting records..."
          cat response.json | jq '.records' > data/menu.json
          
          echo "Done! Records count:"
          cat data/menu.json | jq 'length'

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/menu.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update menu data"
            git push
          fi
